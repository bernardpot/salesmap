<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Location Picker</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <style>
    #map { height: 400px; width: 100%; }
    body { font-family: Arial, sans-serif; text-align: center; }
    input { width: 90%; padding: 8px; margin: 5px; }
    #notification { margin-top: 10px; font-size: 16px; color: green; display: none; }
    #confirmLocationButton { margin-top: 10px; padding: 8px 20px; cursor: pointer; }
  </style>
</head>
<body>
  <h2>Select Your Location</h2>

  <!-- Search Box -->
  <input type="text" id="addressSearch" placeholder="Search for an address" />

  <!-- Map -->
  <div id="map"></div>

  <!-- Confirm Button -->
  <button id="confirmLocationButton">Confirm Location</button>

  <!-- Success Notification -->
  <div id="notification">Location has been captured!</div>

  <script>
    // Initial Map Setup
    var map = L.map('map').setView([-26.707930, 27.101352], 13);  // Default coordinates for map

    // Satellite Tile Layer (Mapbox)
    L.tileLayer('https://api.mapbox.com/styles/v1/mapbox/satellite-v9/tiles/{z}/{x}/{y}?access_token=YOUR_MAPBOX_ACCESS_TOKEN', {
      attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, ' +
        '<a href="https://www.mapbox.com/about/maps/">Imagery Â© Mapbox</a>',
      tileSize: 512,
      zoomOffset: -1
    }).addTo(map);

    // Marker Variable
    var marker;

    // Geocoder for Address Search
    var geocoder = L.Control.Geocoder.nominatim();

    // Store the selected location data
    var selectedLat, selectedLng, selectedAddress;

    // Handle Map Click Event
    map.on('click', function(event) {
      selectedLat = event.latlng.lat;
      selectedLng = event.latlng.lng;

      // Place marker on the map
      if (marker) {
        marker.setLatLng(event.latlng);
      } else {
        marker = L.marker(event.latlng).addTo(map);
      }

      // Reverse Geocode to get the address
      geocoder.reverse([selectedLat, selectedLng], map.options.crs.scale(map.getZoom()), function(results) {
        if (results.length > 0) {
          selectedAddress = results[0].formatted_address;
          document.getElementById('addressSearch').value = selectedAddress;
        }
      });
    });

    // Handle Address Search Input
    document.getElementById('addressSearch').addEventListener('input', function() {
      var query = this.value;
      if (query) {
        geocoder.geocode(query, function(results) {
          if (results.length > 0) {
            var latLng = results[0].center;
            map.setView(latLng, 13);
            selectedLat = latLng.lat;
            selectedLng = latLng.lng;
            selectedAddress = results[0].name;

            // Place marker on the map
            if (marker) {
              marker.setLatLng(latLng);
            } else {
              marker = L.marker(latLng).addTo(map);
            }

            // Update the address field
            document.getElementById('addressSearch').value = selectedAddress;
          }
        });
      }
    });

    // Confirm Location Button
    document.getElementById('confirmLocationButton').addEventListener('click', function() {
      if (selectedLat && selectedLng && selectedAddress) {
        // Send the confirmed location to the parent (JotForm)
        window.parent.postMessage({
          type: 'locationSelected',
          latitude: selectedLat,
          longitude: selectedLng,
          address: selectedAddress
        }, '*');  // Use the correct origin if needed, or '*' to allow any origin

        // Show Success Notification
        document.getElementById('notification').style.display = 'block';

        // Hide the notification after 2 seconds
        setTimeout(function() {
          document.getElementById('notification').style.display = 'none';
        }, 2000);
      } else {
        alert('Please select a location first.');
      }
    });
  </script>
</body>
</html>
